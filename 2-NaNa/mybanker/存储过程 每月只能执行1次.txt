CREATE OR REPLACE PROCEDURE P_StatisticsInfo
IS
thisyear varchar(2);--当前的年份12
thismonth varchar(2);--当前月份03
strdate varchar(18);--开始时间
enddate varchar(18);--结束时间
cursor stalist is
--List集合
select cg.name,k.grp_id,k.jcs,k.jda,k.jwt,k.jzl,k.jqx,k.ccs,k.cda,k.cwt,k.czl,k.cqx from (
select i.grp_id,i.jcs,i.jda,i.jwt,i.jzl,i.jqx,g.ccs,g.cda,g.cwt,g.czl,g.cqx from (
select h.grp_id,h.jcs,h.jda,h.jwt,h.jzl,e.jqx from (
select j.grp_id,j.jcs,j.jda,j.jwt,d.jzl from (
select f.grp_id,f.jcs,f.jda,c.jwt from (
select a.grp_id,a.jcs,b.jda from (
select cgu.grp_id ,count(*) jcs
 from usersession us, c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where us.regname = cu.regname
 and cgu.usr_id=cu.usr_id
 and cui.usr_id=cu.usr_id
 and cui.experttype = 10003
 and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
 and us.sessionstart > to_date(strdate, 'yyyy-mm-dd')
 and us.sessionstart < to_date(enddate, 'yyyy-mm-dd')
 group by cgu.grp_id) a left join
(select cgu.grp_id,count(*) jda
from ks_answer ka,c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
  where ka.creatorid=cu.usr_id
  and cu.usr_id=cgu.usr_id
  and cgu.usr_id=cui.usr_id
  and cui.experttype=10003
  and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
  and ka.createddate > to_date(strdate, 'yyyy-mm-dd')
  and ka.createddate < to_date(enddate, 'yyyy-mm-dd')
  group by cgu.grp_id) b
  on a.grp_id =b.grp_id) f
  left join
 (select cgu.grp_id,count(*) jwt
from ks_problem kp,c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where kp.creatorid=cu.usr_id
and cu.usr_id=cgu.usr_id
and cgu.usr_id=cui.usr_id
and cui.experttype=10003
and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
and kp.createddate > to_date(strdate, 'yyyy-mm-dd')
and kp.createddate < to_date(enddate, 'yyyy-mm-dd')
group by cgu.grp_id) c
on f.grp_id=c.grp_id) j
left join
(select cgu.grp_id,count(*) jzl from ks_document kd,c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where kd.creatorid=cu.usr_id
and cu.usr_id=cgu.usr_id
and cgu.usr_id=cui.usr_id
and cui.experttype=10003
and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
and kd.createdate> to_date(strdate, 'yyyy-mm-dd')
and kd.createdate < to_date(enddate, 'yyyy-mm-dd')
group by cgu.grp_id) d
on j.grp_id=d.grp_id) h
left join
(select cgu.grp_id,count(*) jqx
from c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where cu.usr_id=cgu.usr_id
and cgu.usr_id=cui.usr_id
and cui.experttype=10003
 and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
and cgu.createddate > to_date(strdate, 'yyyy-mm-dd')
and cgu.createddate < to_date(enddate, 'yyyy-mm-dd')
group by cgu.grp_id
) e
on h.grp_id=e.grp_id) i
left join (
select h.grp_id,h.ccs,h.cda,h.cwt,h.czl,e.cqx from (
select j.grp_id,j.ccs,j.cda,j.cwt,d.czl from (
select f.grp_id,f.ccs,f.cda,c.cwt from (
select a.grp_id,a.ccs,b.cda from (
select cgu.grp_id ,count(*) ccs
 from usersession us, c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where us.regname = cu.regname
 and cgu.usr_id=cu.usr_id
 and cui.usr_id=cu.usr_id
 and cui.experttype = 10004
  and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
 and us.sessionstart > to_date(strdate, 'yyyy-mm-dd')
 and us.sessionstart < to_date(enddate, 'yyyy-mm-dd')
 group by cgu.grp_id) a left join
(select cgu.grp_id,count(*) cda
from ks_answer ka,c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
  where ka.creatorid=cu.usr_id
  and cu.usr_id=cgu.usr_id
  and cgu.usr_id=cui.usr_id
  and cui.experttype=10004
   and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
  and ka.createddate > to_date(strdate, 'yyyy-mm-dd')
  and ka.createddate < to_date(enddate, 'yyyy-mm-dd')
  group by cgu.grp_id) b
  on a.grp_id =b.grp_id) f
  left join
 (select cgu.grp_id,count(*) cwt
from ks_problem kp,c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where kp.creatorid=cu.usr_id
and cu.usr_id=cgu.usr_id
and cgu.usr_id=cui.usr_id
and cui.experttype=10004
and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
and kp.createddate > to_date(strdate, 'yyyy-mm-dd')
and kp.createddate < to_date(enddate, 'yyyy-mm-dd')
group by cgu.grp_id) c
on f.grp_id=c.grp_id) j
left join
(select cgu.grp_id,count(*) czl from ks_document kd,c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where kd.creatorid=cu.usr_id
and cu.usr_id=cgu.usr_id
and cgu.usr_id=cui.usr_id
and cui.experttype=10004
and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
and kd.createdate> to_date(strdate, 'yyyy-mm-dd')
and kd.createdate < to_date(enddate, 'yyyy-mm-dd')
group by cgu.grp_id) d
on j.grp_id=d.grp_id) h
left join
(select cgu.grp_id,count(*) cqx
from c_user cu,c_goup_user cgu,C_USEROTHERINFO cui
where cu.usr_id=cgu.usr_id
and cgu.usr_id=cui.usr_id
and cui.experttype=10004
and exists (select grp_id from (select grp_id from c_group where parentid=9002 union all select grp_id from c_group where parentid in(select grp_id from c_group where parentid=9002) union all select grp_id from c_group where parentid in(select grp_id  from c_group where parentid in(select grp_id from c_group where parentid=9002))))
and cgu.createddate > to_date(strdate, 'yyyy-mm-dd')
and cgu.createddate < to_date(enddate, 'yyyy-mm-dd')
group by cgu.grp_id
) e on h.grp_id=e.grp_id
) g on i.grp_id=g.grp_id) k,c_group cg where k.grp_id=cg.grp_id;
--
begin
   --得到当前年
   select substr(TO_CHAR(sysdate,'yyyy-mm-dd'),3,2) into thisyear from dual;
   --得到当前月份
   select substr(TO_CHAR(sysdate,'yyyy-mm-dd'),6,2) into thismonth from dual;

   DBMS_OUTPUT.put_line('当前年'||thisyear);
   DBMS_OUTPUT.put_line('当前月份'||thismonth);
   DBMS_OUTPUT.put_line('---日期格式需根据情况修改---'||thisyear||thismonth);

   --得到上个月的最后一天
   select TO_CHAR(last_day(add_months(sysdate,-1)),'yyyy-mm-dd') into enddate from dual;
   --判断月份
   if thismonth='01' then
      --循环三次 分别统计 月报 季报 年报
      for i in 1..3 Loop
            DBMS_OUTPUT.put_line('一月份统计月报 季报 年报'||i);
            if i=1 then
               --得到上个月的第一天   -2月报
               select TO_CHAR(last_day(add_months(sysdate,-2))+1,'yyyy-mm-dd') into strdate from dual;
               --循环开始
               FOR rec in stalist Loop
                   DBMS_OUTPUT.put_line(rec.grp_id||'----'||rec.jcs);
                   insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,1,thisyear-1||thismonth,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
                   commit;
               end Loop;
               DBMS_OUTPUT.put_line('开始时间'||strdate);
               DBMS_OUTPUT.put_line('结束时间'||enddate);
            elsif i=2 then
               --得到月的第一天   -4季报
               select TO_CHAR(last_day(add_months(sysdate,-4))+1,'yyyy-mm-dd') into strdate from dual;
               --循环开始
               FOR rec in stalist Loop
                   DBMS_OUTPUT.put_line(rec.grp_id||'----'||rec.jcs);
                   insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,2,thisyear-1||4,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
                   commit;
               end Loop;
               DBMS_OUTPUT.put_line('开始时间'||strdate);
               DBMS_OUTPUT.put_line('结束时间'||enddate);
            elsif i=3 then
               --得到月的第一天   -13年报
               select TO_CHAR(last_day(add_months(sysdate,-13))+1,'yyyy-mm-dd') into strdate from dual;
               --循环开始
               FOR rec in stalist Loop
                   DBMS_OUTPUT.put_line(rec.grp_id||'----'||rec.jcs);
                   insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,3,thisyear-1,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
                   commit;
               end Loop;
               DBMS_OUTPUT.put_line('开始时间'||strdate);
               DBMS_OUTPUT.put_line('结束时间'||enddate);
            end if;
      end Loop;
   elsif thismonth='04' or thismonth='07' or thismonth='10' then
      --循环两次 分别统计 月报 季报
      for i in 1..2 Loop
            DBMS_OUTPUT.put_line('统计月报 季报'||i);
            --得到上个月的最后一天
            select TO_CHAR(last_day(add_months(sysdate,-1)),'yyyy-mm-dd') into enddate from dual;
            if i=1 then
               --得到上个月的第一天   -2月报
               select TO_CHAR(last_day(add_months(sysdate,-2))+1,'yyyy-mm-dd') into strdate from dual;
               --循环开始
               FOR rec in stalist Loop
                   DBMS_OUTPUT.put_line(rec.grp_id||'----'||rec.jcs);
                   insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,1,thisyear||thismonth-1,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
                   commit;
               end Loop;
               DBMS_OUTPUT.put_line('开始时间'||strdate);
               DBMS_OUTPUT.put_line('结束时间'||enddate);
            elsif i=2 then
               --得到月的第一天   -4季报
               select TO_CHAR(last_day(add_months(sysdate,-4))+1,'yyyy-mm-dd') into strdate from dual;
               --循环开始
               FOR rec in stalist Loop
                   DBMS_OUTPUT.put_line(rec.grp_id||'----'||rec.jcs);
                   if thismonth=4 then
                     insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,2,thisyear||1,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
                     commit;
                   elsif thismonth=7 then
                     insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,2,thisyear||2,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
                     commit;
                   elsif thismonth=10 then
                     insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,2,thisyear||3,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
                     commit;
                   end if;
               end Loop;
               DBMS_OUTPUT.put_line('开始时间'||strdate);
               DBMS_OUTPUT.put_line('结束时间'||enddate);
            end if;
      end Loop;
   elsif thismonth='02' or thismonth='03' or thismonth='05' or thismonth='06' or thismonth='08' or thismonth='09' or thismonth='11' or thismonth='12' then
      DBMS_OUTPUT.put_line('这是2,3,5,6,8,9,11,12月份的月报');
      --得到上个月的第一天 -1月报
      select TO_CHAR(last_day(add_months(sysdate,-2))+1,'yyyy-mm-dd') into strdate from dual;
      --循环开始
      FOR rec in stalist Loop
          DBMS_OUTPUT.put_line(rec.grp_id||'----'||rec.jcs);
          insert into statistics values(c_tableseq_seq.nextval,rec.grp_id,1,thisyear||thismonth-1,rec.jqx,rec.jcs,rec.jzl,rec.jwt,rec.jda,rec.cqx,rec.ccs,rec.czl,rec.cwt,rec.cda);
          commit;
      end Loop;
      DBMS_OUTPUT.put_line('开始时间'||strdate);
      DBMS_OUTPUT.put_line('结束时间'||enddate);
   end if;
   exception
   when others then
   --DBMS_OUTPUT.put_line('error');
   rollback;
end;
